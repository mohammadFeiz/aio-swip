"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _aioGeo=_interopRequireDefault(require("aio-geo")),_aioUtils=require("aio-utils"),_jquery=_interopRequireDefault(require("jquery"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==typeof e?e:e+""}function _toPrimitive(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}class Swip{constructor(t){_defineProperty(this,"p",void 0),_defineProperty(this,"geo",void 0),_defineProperty(this,"timeout",void 0),_defineProperty(this,"count",void 0),_defineProperty(this,"domLimit",void 0),_defineProperty(this,"parentLimit",void 0),_defineProperty(this,"getDom",void 0),_defineProperty(this,"getParent",void 0),_defineProperty(this,"init",void 0),_defineProperty(this,"dx",void 0),_defineProperty(this,"dy",void 0),_defineProperty(this,"cx",void 0),_defineProperty(this,"cy",void 0),_defineProperty(this,"dist",void 0),_defineProperty(this,"so",void 0),_defineProperty(this,"getPercentByValue",void 0),_defineProperty(this,"getMousePosition",void 0),_defineProperty(this,"click",void 0),_defineProperty(this,"mouseDown",void 0),_defineProperty(this,"mouseMove",void 0),_defineProperty(this,"mouseUp",void 0),_defineProperty(this,"getDOMLimit",void 0),_defineProperty(this,"change",void 0),_defineProperty(this,"getPage",void 0),_defineProperty(this,"isMoving",void 0),_defineProperty(this,"centerAngle",void 0),_defineProperty(this,"defaultLimit",void 0),_defineProperty(this,"addSelectRect",void 0),_defineProperty(this,"setSelectRect",void 0),_defineProperty(this,"removeSelectRect",void 0),_defineProperty(this,"selectRect",void 0),_defineProperty(this,"getIsInSelectRect",void 0),_defineProperty(this,"defaultChange",void 0);let{selectRect:e}=t;if(e){let{color:i="#96a9bc"}=e;this.selectRect={...e,color:i}}this.defaultChange={x:0,y:0,dx:0,dy:0,dist:0,angle:0,deltaCenterAngle:0},this.defaultLimit={width:0,height:0,left:0,top:0,right:0,bottom:0,centerX:0,centerY:0},this.domLimit=this.defaultLimit,this.parentLimit=this.defaultLimit,this.change={x:0,y:0,dx:0,dy:0,dist:0,angle:0,deltaCenterAngle:0},this.addSelectRect=()=>{},this.setSelectRect=()=>{},this.removeSelectRect=()=>{},this.so={},this.p=t,this.geo=new _aioGeo.default,this.timeout=void 0,this.count=0,this.getDom=()=>t.dom(),this.getParent=()=>t.parent?t.parent():void 0,this.dx=0,this.dy=0,this.cx=0,this.cy=0,this.dist=0,this.isMoving=!1,this.centerAngle=0,this.init=()=>{if(this.count++,this.count>10){clearTimeout(this.timeout);return}this.getDom().length?(clearTimeout(this.timeout),(0,_aioUtils.EventHandler)(this.getDom(),"mousedown",_jquery.default.proxy(this.mouseDown,this)),t.onClick&&(0,_aioUtils.EventHandler)(this.getDom(),"click",_jquery.default.proxy(this.click,this))):this.timeout=setTimeout(()=>this.init(),400)},this.getPercentByValue=(t,e,i)=>100*(t-e)/(i-e),this.getPage=()=>{let{page:t}=this.p;return t?t():(0,_jquery.default)(window)},this.getMousePosition=t=>{this.domLimit=this.getDOMLimit("dom");let e=this.getPage(),i=e.scrollTop(),s=e.scrollLeft(),o=(0,_aioUtils.GetClient)(t),h=o.x-this.domLimit.left+s,r=o.y-this.domLimit.top+i,n=this.getPercentByValue(h,0,this.domLimit.width),d=this.getPercentByValue(r,0,this.domLimit.height),l=this.geo.getAngle([[this.domLimit.centerX,this.domLimit.centerY],[o.x,o.y]]);return{xp:n,yp:d,clientX:o.x,clientY:o.y,x:h,y:r,centerAngle:l}},this.getDOMLimit=t=>{let e="dom"===t?this.getDom():this.getParent(),i=e.offset(),s={width:e.width(),height:e.height(),left:i.left,top:i.top,centerX:0,centerY:0};return{...s,centerX:s.left+s.width/2,centerY:s.top+s.height/2,right:s.left+s.width,bottom:s.top+s.height}},this.click=e=>{if(this.isMoving)return;this.domLimit=this.getDOMLimit("dom"),this.parentLimit=t.parent?this.getDOMLimit("parent"):this.defaultLimit;let i=this.getMousePosition(e),s={mousePosition:i,domLimit:this.domLimit,parentLimit:this.parentLimit,event:e,change:this.defaultChange};t.onClick&&t.onClick(s)},this.addSelectRect=(t,e)=>{if(!this.selectRect||!this.selectRect.enable())return;let{color:i}=this.selectRect,s=this.getDom();this.so.tsr={left:t,top:e},this.removeSelectRect(),s.append(`<div class="swip-select-rect" style="border:1px dashed ${i};background:${i+"30"};left:${t}px;top:${e}px;position:absolute;width:0;height:0"></div>`)},this.setSelectRect=(t,e)=>{if(!this.selectRect||!this.selectRect.enable())return;let i=this.getDom().find(".swip-select-rect"),{tsr:s={left:0,top:0}}=this.so||{},o=s.left,h=s.top;t<0&&(o+=t,t=Math.abs(t)),e<0&&(h+=e,e=Math.abs(e));let r={left:o,top:h,width:t,height:e};this.so.sr=r,i.css(r)},this.removeSelectRect=()=>{if(this.selectRect&&this.selectRect.enable())this.getDom().find(".swip-select-rect").remove()},this.mouseDown=e=>{e.stopPropagation(),this.isMoving=!1,this.domLimit=this.getDOMLimit("dom"),this.parentLimit=t.parent?this.getDOMLimit("parent"):this.defaultLimit;let i=this.getMousePosition(e);this.centerAngle=i.centerAngle,this.cx=i.clientX,this.cy=i.clientY,this.so={client:{x:i.clientX,y:i.clientY}},this.addSelectRect(i.x,i.y);let s={mousePosition:i,domLimit:this.domLimit,parentLimit:this.parentLimit,event:e,change:this.defaultChange},o=(t.start||(()=>[0,0]))(s);if(!Array.isArray(o))return;let h=o[0],r=o[1];this.so={...this.so,x:h,y:r},(0,_aioUtils.EventHandler)("window","mousemove",_jquery.default.proxy(this.mouseMove,this)),(0,_aioUtils.EventHandler)("window","mouseup",_jquery.default.proxy(this.mouseUp,this))},this.mouseMove=t=>{t.stopPropagation();let{speedX:e=1,speedY:i=1,stepX:s=1,stepY:o=1,reverseX:h,reverseY:r,insideX:n,insideY:d}=this.p,l=this.getMousePosition(t),m=(0,_aioUtils.GetClient)(t),c=m.x-this.cx,p=m.y-this.cy;c=Math.round(c*e)*(h?-1:1),p=Math.round(p*i)*(r?-1:1);let a=l.centerAngle-this.centerAngle;if("number"==typeof s&&(c=Math.round(c/s)*s),"number"==typeof o&&(p=Math.round(p/o)*o),c===this.dx&&p===this.dy)return;this.isMoving=!0,this.dx=c,this.dy=p,this.dist=Math.round(Math.sqrt(Math.pow(c,2)+Math.pow(p,2)));let $=this.geo.getAngle([[this.cx,this.cy],[m.x,m.y]]);this.setSelectRect(c,p);let u=0,g=0;if(void 0!==this.so.x&&void 0!==this.so.y){u=this.so.x+c,g=this.so.y+p;let{minX:f,minY:v,maxX:y,maxY:P}=this.p;void 0!==f&&u<f&&(u=f),void 0!==y&&u>y&&(u=y),void 0!==v&&g<v&&(g=v),void 0!==P&&g>P&&(g=P)}!0===s&&(u=Math.round(u/this.domLimit.width)*this.domLimit.width),!0===o&&(g=Math.round(g/this.domLimit.height)*this.domLimit.height),n&&(this.parentLimit?(u>this.parentLimit.width-this.domLimit.width&&(u=this.parentLimit.width-this.domLimit.width),u<0&&(u=0)):alert("Swip error => you set insideX prop but missing parent props")),d&&(this.parentLimit?(g>this.parentLimit.height-this.domLimit.height&&(g=this.parentLimit.height-this.domLimit.height),g<0&&(g=0)):alert("Swip error => you set insideY prop but missing parent props")),this.change={x:u,y:g,dx:c,dy:p,dist:this.dist,angle:$,deltaCenterAngle:a};let L={change:this.change,mousePosition:l,domLimit:this.domLimit,parentLimit:this.parentLimit,event:t,selectRect:this.so.sr,isInSelectRect:this.getIsInSelectRect(this.so.sr||{left:0,top:0,width:0,height:0})};this.p.move&&this.p.move(L)},this.getIsInSelectRect=t=>{let{left:e,top:i,width:s,height:o}=t;return(t,h)=>!(t<e)&&!(h<i)&&!(t>e+s)&&!(h>i+o)},this.mouseUp=t=>{t.stopPropagation(),(0,_aioUtils.EventHandler)("window","mousemove",this.mouseMove,"unbind"),(0,_aioUtils.EventHandler)("window","mouseup",this.mouseUp,"unbind"),setTimeout(()=>this.isMoving=!1,10);let e=this.getMousePosition(t);this.removeSelectRect();let i={change:this.change,event:t,domLimit:this.domLimit,parentLimit:this.parentLimit,mousePosition:e,selectRect:this.so.sr,isInSelectRect:this.getIsInSelectRect(this.so.sr||{left:0,top:0,width:0,height:0})};this.p.end&&this.p.end(i)},this.init()}}exports.default=Swip;